---
layout: post
title:  The space of Flow Models
date:   2023-05-25 10:00
description: A precise derriavation of the score-matching objective.
tags: flow-matching, generative-models
categories: generative modelling
---

## Introduction
A key task in generative modelling is to generate data similar to some given data.
Formally speaking, assume:
- we have a dataset $D \subset \mathbb{R}^n$ (e.g. of images);
- there exists a probability density function (PDF) $q \in \mathcal{P}(\mathbb{R}^n)$ s.t. $D \subseteq \mathrm{supp}(q)$, where $\mathcal{P}(\mathbb{R}^n)$ is the space of PDFs on $\mathbb{R}^n$.

*Now the question is: how do we sample from $p$?*
Well, we can try to approximate $p$ with a neural network (NN), but the difficult thing is that the space of PDFs on $\mathbb{R}^n$ is defined as
$$
\mathcal{P}(\mathbb{R}^n) := \left\{f \in C(\mathbb{R}^n, [0,1]) ~\Big\vert \int_\mathbb{R}^n f(\mathbf{x}) \mathrm{d}\mathbf{x} = 1 \right\}.
$$
This predicate is difficult to enforce in practice for NNs as the dimensionality of $\mathbb{R}^n$ increases.

However, in the past few years, *flow-based generative models* have been used overcome this challenge, whereby, instead of learning $q$, 
we learn a vector field (VF) $\mathbf{v}_\theta \in C^\infty(T\mathbb{R}^n)$ that transports a simple distribution $q_0$ to $q_1$ via its integral map (i.e. flow) $\mathbf{\phi} \in C^\infty(\mathbb{R}^n \times \mathbb{R}_{\geq 0}, \mathbb{R}^n)$ through the push-forward equation
$$
p(\mathbf{x}, t) = q_0(\mathbf{\phi}^{-1}(\mathbf{x}, t)) \left\vert  \frac{\partial \mathbf{\phi}^{-1}(\mathbf{x}, t)}{\partial \mathbf{x}}  \right\vert,
$$
s.t. hopefully $p(x, t) \approx q_1(x)$ for some $t \in \mathbb{R}_{\geq 0}$.




### CNFs, Conditional CNFS, and Marginal CNFs

Here, we will try to give a concise axiomatisation of Flow Matching framework.

**Definition (Basic Spaces)**

We denote the:
- state space as $$\mathbb{R}^n$$ with $$n \in \mathbb{N}$$;
- time space as $$\mathbb{R}_{\geq 0}$$;
- continuously differentiable function space as $$C^\infty(\cdot, \cdot)$$;
- stationary PDF space as $$\mathcal{P}(\mathbb{R}^n) := \left\{f \in C^\infty(\mathbb{R}^n, [0,1]) ~\Big\vert \int_{\mathbb{R}^n} f(\mathbf{x}) \mathrm{d}\mathbf{x} = 1 \right\}$$;
- dynamic PDF space as $$\mathcal{P}(\mathbb{R}^n \times \mathbb{R}_{\geq 0}) := \left\{f \in C^\infty(\mathbb{R}^n \times \mathbb{R}_{\geq 0}, [0,1]) ~\Big\vert \int_{\mathbb{R}^n} f(\mathbf{x}, t) \mathrm{d}\mathbf{x} = 1 \right\}$$.

**Problem (Generative modelling)**

If there exists:
- a tractable dataset $$D \subset \mathbb{R}^n$$;
- an intractable stationary PDF $$q_1 \in \mathcal{P}(\mathbb{R}^n)$$ s.t. $$D \subseteq \mathrm{supp}(q_1)$$;
- a tractable stationary PDF $$q_0 \in \mathcal{P}(\mathbb{R}^n)$$;

how do we sample from $$q_1$$?

**Definition (CNF Space)**

A set of function pairs

$$
\mathfrak{F} :\subset 
C^\infty(\mathbb{R}^n \times \mathbb{R}_{\geq 0}, \mathbb{R}^n) \times 
C^\infty(\mathbb{R}^n \times \mathbb{R}_{\geq 0}, \mathbb{R}^n) \times 
\mathcal{P}(\mathbb{R}^n \times \mathbb{R}_{\geq 0})
$$

s.t. for all $$(\mathbf{v}, \mathbf{\phi}, p) \in \mathfrak{F}$$:

$$
\begin{aligned}
    \frac{\partial \mathbf{\phi}(\mathbf{x}, t)}{\partial t} &= \mathbf{v}(\mathbf{\phi}(\mathbf{x}, t), t) \\
    \frac{\partial p(\mathbf{x}, t)}{\partial t} &= -\nabla_{\mathbf{x}} \cdot \left( \mathbf{v}(\mathbf{x}, t) p(\mathbf{x}, t) \right).
\end{aligned}
$$

where $$\mathbf{v}$$ is a *vector field*, $$\mathbf{\phi}$$ is a *flow*, and $$p$$ is a *PDF path*. The first condition (ODE equation) says that $$\mathbf{\phi}$$ is an integral map of $$\mathbf{v}$$, and the second condition (continuity equation) says that $$p$$ is generated by $$\mathbf{v}$$ (i.e. satisfies the push-forward equation), where $$\nabla_\mathbf{x} \cdot$$ denotes the divergence operator.

**Definition (Conditional CNF Space)**

A set of functions that map from the data space to the CNF space

$$
\mathfrak{F}_c :\subset C^\infty(D, \mathfrak{F})
$$

s.t. for all $$(\mathbf{x}_1, (\mathbf{v}_c, \mathbf{\phi}_c, p_c)) \in D \times \mathfrak{F}_c$$ we have $$(\mathbf{v}_c(\cdot \mid \mathbf{x}_1), \mathbf{\phi}_c(\cdot \mid \mathbf{x}_1), p_c(\cdot \mid \mathbf{x}_1)) \in \mathfrak{F}$$.

**Definition (Marginal CNF Space)**

A set of CNF and Conditional CNF pairs

$$
\mathfrak{F}_m :\subset \mathfrak{F} \times \mathfrak{F}_c
$$

s.t. for all $$((\mathbf{v}, \mathbf{\phi}, p), (\mathbf{\phi}_c, \mathbf{v}_c, p_c)) \in \mathfrak{F}_m$$:

$$
p(\mathbf{x}, t) = \int_{D} p_c(\mathbf{x}, t \mid \mathbf{x}_1) q_1(\mathbf{x}_1) \mathrm{d}\mathbf{x}_1.
$$

**Theorem (Marginal Vector Field (Lipman))**

For all Marginal CNF pairs $$((\mathbf{v}, \mathbf{\phi}, p), (\mathbf{\phi}_c, \mathbf{v}_c, p_c)) \in \mathfrak{F}_m$$:

$$
\mathbf{v}(\mathbf{x}, t) = \frac{1}{p(\mathbf{x}, t)} \int_{D} \mathbf{v}_c(\mathbf{x}, t \mid \mathbf{x}_1) p_c(\mathbf{x}, t \mid \mathbf{x}_1) q_1(\mathbf{x}_1) \mathrm{d}\mathbf{x}_1.
$$

*Proof*:

$$
\begin{aligned}
    \frac{\partial p(\mathbf{x}, t)}{\partial t} &\overset{(i)}{=} \frac{\partial}{\partial t} \int_{D} p_c(\mathbf{x}, t \mid \mathbf{x}_1) q_1(\mathbf{x}_1) \mathrm{d}\mathbf{x}_1 \\
    &\overset{(ii)}{=}  \int_{D} \frac{\partial p_c(\mathbf{x}, t \mid \mathbf{x}_1)}{\partial t} q_1(\mathbf{x}_1) \mathrm{d}\mathbf{x}_1 \\
    &\overset{(iii)}{=} \int_{D}
    \left( -\nabla_{\mathbf{x}} \cdot \left( \mathbf{v}(\mathbf{x}, t \mid \mathbf{x}_1) p(\mathbf{x}, t \mid \mathbf{x}_1) \right)\right)
    q_1(\mathbf{x}_1) \mathrm{d}\mathbf{x}_1 \\
    &\overset{(iv)}{=} -\nabla_{\mathbf{x}} \cdot \int_{D}
      \mathbf{v}(\mathbf{x}, t \mid \mathbf{x}_1) p(\mathbf{x}, t \mid \mathbf{x}_1)
    q_1(\mathbf{x}_1) \mathrm{d}\mathbf{x}_1 \\
    &\overset{(v)}{=} -\nabla_{\mathbf{x}} \cdot \left( \mathbf{v}(\mathbf{x}, t) p(\mathbf{x}, t) \right)\\
\end{aligned}
$$

where $$(i)$$ is by the definition of the Marginal CNF Space, $$(ii)$$ is by the Leibniz integral rule, $$(iii)$$ is by the definition of the CNF Space, $$(iv)$$ is by the Leibniz integral rule, and $$(v)$$ is the statement of the theorem.